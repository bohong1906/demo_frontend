<template>
  <div class="flex flex-col h-screen bg-gray-100">
    <!-- Header -->
    <header class="flex items-center justify-between px-6 py-3 shadow z-10 bg-gradient-to-r from-red-500 to-red-900">
      <div class="flex items-center space-x-2">
        <img src="@/Image/5041657E-FA68-403F-A044-69237735DE38.png" alt="Logo" class="w-8 h-8" />
        <span class="font-bold text-lg text-black">ç«æ˜Ÿåœ˜èŠ± MAX</span>
      </div>
      <div class="flex items-center space-x-4">
        <button
          class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 shadow transition-all duration-150"
          @click="clickMuted">
          <span class="material-icons text-base">{{ isMuted ? 'volume_off' : 'volume_up' }}</span>

          <span class="hidden sm:inline">éœéŸ³</span>
        </button>
        <button
          class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 shadow transition-all duration-150">
          <span class="material-icons text-base">share</span>
          <span class="hidden sm:inline">åˆ†äº«</span>
        </button>
        <button
          class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 shadow transition-all duration-150">
          <span class="material-icons text-base">person_add</span>
          <span class="hidden sm:inline">é‚€è«‹</span>
        </button>
        <button
          class="flex items-center gap-2 px-4 py-2 rounded-full border-2 border-red-600 bg-white text-red-600 font-bold hover:bg-red-600 hover:text-white shadow transition-all duration-150">
          <span class="material-icons text-base">logout</span>
          <span class="hidden sm:inline">é›¢é–‹</span>
        </button>
      </div>
    </header>

    <!-- Main content -->
    <main class="flex flex-1 overflow-hidden">
      <!-- å·¦å´ ç›´æ’­ç•«é¢å€ -->
      <section class="flex-1 flex flex-col px-6 py-8">
        <!-- ä¸ŠåŠéƒ¨ï¼šç›´æ’­ç•«é¢ -->
        <div class="flex-1 flex items-center justify-center pb-2">
          <div
            class="relative w-full h-full max-w-3xl rounded-2xl aspect-video flex items-center justify-center bg-black">
            <video ref="videoRef" :muted="isMuted" autoplay loop playsinline
              class="h-full w-full object-cover rounded-2xl" :controls="false" tabindex="-1"></video>
          </div>
        </div>
        <!-- ä¸‹åŠéƒ¨ï¼šå…­å¼µæ­£æ–¹å½¢ç…§ç‰‡ï¼Œå›ºå®šè¼ƒå¤§å°ºå¯¸ -->
        <div class="flex justify-center items-center gap-10 h-32">
          <img src="@/Image/S__107880475.jpg" alt="å¶åƒ1" class="w-24 h-24 object-cover rounded-lg shadow" />
          <img src="@/Image/S__107880476.jpg" alt="å¶åƒ2" class="w-24 h-24 object-cover rounded-lg shadow" />
          <img src="@/Image/S__107880477.jpg" alt="å¶åƒ3" class="w-24 h-24 object-cover rounded-lg shadow" />
          <img src="@/Image/S__107880479.jpg" alt="å¶åƒ4" class="w-24 h-24 object-cover rounded-lg shadow" />
          <img src="@/Image/S__107880480.jpg" alt="å¶åƒ5" class="w-24 h-24 object-cover rounded-lg shadow" />
          <!--<img src="@/Image/S__107880474.jpg" alt="å¶åƒ6" class="w-24.5 h-24.5 object-cover rounded-lg shadow" />-->
        </div>
        <!-- å¶åƒçµ¦ç²‰çµ²çš„è©± -->
        <div class="mt-2 text-center text-sm text-gray-700 font-medium">
          è¬è¬å¤§å®¶çš„æ”¯æŒï¼Œå’Œä½ å€‘ä¸€èµ·ç›´æ’­çœŸçš„å¾ˆå¹¸ç¦ï¼ğŸˆâ€â¬›ğŸ–¤
        </div>
      </section>
      <!-- å³å´ èŠå¤©å®¤ -->
      <aside class="w-96 min-w-[320px] bg-white/90 border-l flex flex-col">
        <!-- ä¸Šï¼šå¯¦æ³èŠå¤©å®¤æ¨™é¡Œå€ï¼Œä¸‹ï¼šæ’è¡Œæ¦œï¼ˆæœ‰åˆ†éš”ç·šï¼‰ï¼Œä¸‰ç­‰åˆ†é‡‘éŠ€éŠ…ç‰Œç¸®å° -->
        <div class="bg-white/80">
          <!-- æ¨™é¡Œå€ -->
          <div class="p-3 pb-2">
            <div class="font-semibold text-base text-center text-black">å¯¦æ³èŠå¤©å®¤</div>
          </div>
          <!-- åˆ†éš”ç·š -->
          <div class="border-t border-gray-200"></div>
          <!-- æ’è¡Œæ¦œå€ -->
          <div class="p-3">
            <div class="flex flex-row justify-between text-center">
              <!-- ç¬¬ä¸€åï¼ˆå·¦ï¼‰ -->
              <div class="flex-1 flex flex-col items-center">
                <span class="text-xl">ğŸ¥‡</span>
                <span class="mt-1 text-sm font-bold text-yellow-700">ç«æ˜Ÿå°èŠ±</span>
              </div>
              <!-- ç¬¬äºŒåï¼ˆä¸­ï¼‰ -->
              <div class="flex-1 flex flex-col items-center">
                <span class="text-xl">ğŸ¥ˆ</span>
                <span class="mt-1 text-sm font-semibold text-gray-600">Maxç²‰ä¸€è™Ÿ</span>
              </div>
              <!-- ç¬¬ä¸‰åï¼ˆå³ï¼‰ -->
              <div class="flex-1 flex flex-col items-center">
                <span class="text-xl">ğŸ¥‰</span>
                <span class="mt-1 text-sm font-semibold text-gray-600">è¶…ç²‰å°é¦¬</span>

              </div>
            </div>
          </div>
        </div>
        <!-- åˆ†éš”ç·š -->
        <div class="border-t border-gray-200"></div>
        <div class="flex-1 p-4 overflow-y-auto">
          <!-- è¨Šæ¯ä¸² ... -->
          <div v-for="(msg, index) in messages" :key="index" class="text-left text-black text-sm">
            <span class="font-bold">{{ msg.sender }}ï¼š</span>{{ msg.text }}
          </div>
        </div>
        <!-- è¡¨æƒ…ç¬¦è™Ÿäº’å‹•æŒ‰éˆ• row -->
        <div class="border-t border-gray-200 p-2">
          <div class="flex flex-wrap gap-2 justify-start">
            <button v-for="(emoji, index) in emojis" :key="index" @click="sendEmoji(emoji)"
              class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors duration-200"
              :title="emoji.name">
              <span class="text-xl">{{ emoji.icon }}</span>
            </button>
          </div>
        </div>
        <!-- è¨Šæ¯è¼¸å…¥å€ -->
        <div class="border-t p-3 flex items-center space-x-2">
          <input v-model="messageText"
            class="flex-1 border rounded px-3 py-2 bg-gray-300 text-white placeholder-gray-400" placeholder="ç™¼é€è¨Šæ¯..." />
          <button @click="sendMessage"
            class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors duration-200">
            ç™¼é€
          </button>
        </div>
      </aside>
    </main>
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount } from "vue";
import Hls from "hls.js";
import axios from "axios";

const videoRef = ref(null);
const hlsUrl = "http://35.91.162.109:8088/hls/stream.m3u8";

let hls = null;
const loading = ref(true);

const messageText = ref('');
const messages = ref([]);
const playIdleMessage = async () => {
  try {
    const res = await axios.get('http://localhost:8080/idle-message');
    const { reply } = res.data;

    // æ’æ’­è¨Šæ¯ä¹ŸåŠ é€²èŠå¤©å®¤
    messages.value.push({ sender: "Max", text: reply });

  } catch (err) {
    console.error("æ’­æ”¾å¾…æ©Ÿè¨Šæ¯å¤±æ•—", err);
  }
}
const username = ref('ç²‰çµ²');

const isMuted = ref(true);

const clickMuted = () => {
  isMuted.value = !isMuted.value;
  console.log("clicked", isMuted)
}

const emojis = [
  { icon: 'ğŸ‘', name: 'è®š' },
  { icon: 'â¤ï¸', name: 'æ„›å¿ƒ' },
  { icon: 'ğŸ˜Š', name: 'å¾®ç¬‘' },
  { icon: 'ğŸ˜‚', name: 'ç¬‘å“­' },
  { icon: 'ğŸ˜®', name: 'é©šè¨' },
  { icon: 'ğŸ‘‹', name: 'æ®æ‰‹' },
  { icon: 'ğŸ‰', name: 'æ…¶ç¥' },
  { icon: 'ğŸŒŸ', name: 'æ˜Ÿæ˜Ÿ' },
  { icon: 'ğŸ’ª', name: 'åŠ æ²¹' },
  { icon: 'ğŸ™', name: 'æ„Ÿè¬' },
  { icon: 'ğŸ”¥', name: 'ç«ç†±' },
  { icon: 'ğŸ‘', name: 'é¼“æŒ' },
  { icon: 'ğŸ¥³', name: 'æ´¾å°' },
  { icon: 'ğŸ¥°', name: 'é–‹å¿ƒ' },
  { icon: 'ğŸ¤©', name: 'å´‡æ‹œ' },
  { icon: 'ğŸ˜¢', name: 'æ„Ÿå‹•' },
  { icon: 'ğŸ˜¡', name: 'ç”Ÿæ°£' },
  { icon: 'ğŸ¤—', name: 'æ“æŠ±' },
];

// ğŸª„ é€emojiå°±æ˜¯ç›´æ¥ç™¼å‡ºå»ç•¶è¨Šæ¯
const sendEmoji = (emoji) => {
  messages.value.push({
    sender: username.value,
    text: emoji.icon
  });
};

const lastUserMessageTime = ref(Date.now());

// ğŸª„ é€å‡ºæ–‡å­—è¨Šæ¯
const sendMessage = async () => {
  if (messageText.value.trim()) {
    const userMessage = messageText.value.trim();
    // æŠŠè‡ªå·±çš„ç•™è¨€åŠ åˆ°èŠå¤©å®¤
    messages.value.push({ sender: username.value, text: userMessage });

    lastUserMessageTime.value = Date.now();

    try {
      const res = await axios.post('http://localhost:8080/chat-tts', {
        user_prompt: userMessage
      });

      const { reply, audio_file } = res.data;

      // æŠŠ Max çš„å›è¦†ä¹ŸåŠ é€²èŠå¤©å®¤
      messages.value.push({ sender: "Max", text: reply, audio: audio_file });

      // æ’­æ”¾èªéŸ³
      if (audio_file) {
        const audio = new Audio(audio_file);
        await audio.play();
      }
    } catch (err) {
      console.error("é€å‡ºå¤±æ•—", err);
      alert("ç™¼é€å¤±æ•—ï¼");
    }

    messageText.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
  }
};

// è®“ç›´æ’­è‡ªå‹•æ’­æ”¾
onMounted(() => {
  if (Hls.isSupported()) {
    hls = new Hls();
    hls.loadSource(hlsUrl);
    hls.attachMedia(videoRef.value);
    videoRef.value.play();
    hls.on(Hls.Events.MANIFEST_PARSED, function () {
      loading.value = false;
    });
  } else if (videoRef.value.canPlayType("application/vnd.apple.mpegurl")) {
    videoRef.value.src = hlsUrl;
    videoRef.value.play();
    loading.value = false;
  }
  // æ¯ 30 ç§’æ’æ’­ï¼Œä½†å¦‚æœä½¿ç”¨è€…å‰›ç™¼éè¨Šæ¯ï¼Œå°±è·³é
/*  setInterval(async () => {
    const now = Date.now();
    if (lastUserMessageTime && now - lastUserMessageTime < 60000) {
      console.log("ä½¿ç”¨è€…å‰›èªªéè©±ï¼Œæš«ä¸æ’æ’­");
      return;
    }
    await playIdleMessage();
  }, 30000);
*/
});

onBeforeUnmount(() => {
  if (hls) {
    hls.destroy();
    hls = null;
  }
});
</script>


<style scoped>
@keyframes fade-in-down {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fade-in-up {
  from {
    opacity: 0;
    transform: translateY(30px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in-down {
  animation: fade-in-down 0.7s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-fade-in-up {
  animation: fade-in-up 0.7s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
}

button:focus {
  outline: 2px solid #4f46e5;
  outline-offset: 2px;
}
</style>
